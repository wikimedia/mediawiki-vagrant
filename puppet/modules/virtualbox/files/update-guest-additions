#!/usr/bin/env bash
#
# VirtualBox Guest Additions Upgrade Helper
#
# Reads host's VirtualBox version from /etc/virtualbox-version, which is
# generated by Puppet. Fetches appropriate version of Guest Additions ISO from
# Oracle and installs it.
#
# This file is managed by Puppet.
#

warn () {
	printf "$(tput setaf 1)%s$(tput sgr0)\n" "$1" >&2
}

notice () {
	printf "$(tput setaf 4)%s$(tput sgr0)\n" "$1"
}

# Re-run under 'sudo' if not invoked with 'sudo'.

[[ ! $SUDO_COMMAND ]] && {
    sudo $0
    exit $?
}

# Allow VirtualBox version to be specified via '--virtualbox-version'
# command-line argument:
[[ "$*" =~ --virtualbox-version.([0-9][0-9.]+) ]] && {
    VIRTUALBOX_VERSION="${BASH_REMATCH[1]}"
}

# If the version was not specified as a command-line argument, try to
# read it from /etc/virtualbox-version:
[[ ! $VIRTUALBOX_VERSION && -r "/etc/virtualbox-version" ]] && {
    VIRTUALBOX_VERSION="$(</etc/virtualbox-version)"
}

[[ ! $VIRTUALBOX_VERSION ]] && {
    warn 'Cannot determine host VirtualBox version! You can specify it using --virtualbox-version.'
    exit 1
}

BASE_URL="http://download.virtualbox.org/virtualbox/${VIRTUALBOX_VERSION}"
GUEST_ADDITIONS_ISO="VBoxGuestAdditions_${VIRTUALBOX_VERSION}.iso"
GUEST_ADDITIONS_VERSION="$(modinfo -Fversion vboxguest)"

# Check if Guest additions need to be updated.

[[ $GUEST_ADDITIONS_VERSION == "$VIRTUALBOX_VERSION" && ! "$*" =~ --force ]] && {
    notice 'Guest additions already up-to-date.' >&2
    exit 0
}


# Download the Guest additions ISO.

cd /tmp
notice "Downloading ${GUEST_ADDITIONS_ISO}..."
curl -LOf "${BASE_URL}/${GUEST_ADDITIONS_ISO}" || {
    warn 'Unable to retrieve guest additions.'
    exit 1
}


# Verify integrity of downloaded ISO using MD5 checksum

( curl -Lfs "${BASE_URL}/MD5SUMS" | grep "${GUEST_ADDITIONS_ISO}" | md5sum -c ) || {
    warn 'Could not verify data integrity of guest additions ISO.'
    rm "${GUEST_ADDITIONS_ISO}"
    exit 1
}


# Mount Guest additions ISO

MOUNTPOINT="$(mktemp -d guest-additions.XXXXXX)"
mount -o loop,ro "${GUEST_ADDITIONS_ISO}" "${MOUNTPOINT}" || {
    warn 'Unable to mount guest additions ISO.'
    exit 1
}


# Purge conflicting packages and ensure pre-requisites are installed.

notice "Installing dependencies..."
apt-get -y -q install "dkms" "linux-headers-$(uname -r)" || {
    warn 'Unable to install pre-requisite packages.'
    exit 1
}
notice "Removing conflicting packages..."
apt-get -y -q purge virtualbox-guest-dkms virtualbox-guest-utils virtualbox-guest-x11


# Run the installer

notice "Running installer. Ignore any warnings about the 'Window System' or missing 'X.Org' or 'XFree86'."
cd "${MOUNTPOINT}"
./VBoxLinuxAdditions.run --nox11 -- force && {
    notice 'All done. Shutting down. Run "vagrant up" to start the machine.'
    shutdown -h now
}
