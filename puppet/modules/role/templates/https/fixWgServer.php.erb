// <?php
// This file is managed by Puppet.

// Fix wgServer in wgConf. The $wgServer and $wgCanonicalServer globals will be fixed
// in CommonSettings.php, which runs after the settings.d settings.
//
// It changes the wgConf wgServer/wgCanonicalServer to use the HTTPS port.
call_user_func(function () {
	global $wgConf;

	$detectedServer = WebRequest::detectServer();

	// Same as wgConf.php.erb, but at runtime so we use PHP.
	// Actual //host:port the current web request used, without http/https.
	$currentRequestServer = preg_replace( '#^[^\/]+#', '', $detectedServer );

	$currentRequestHostAndPort = \Wikimedia\IPUtils::splitHostAndPort( $currentRequestServer );

	if ( $currentRequestHostAndPort === false ) {
		// Failure to parse current request, change nothing
		return;
	}

    foreach ( [ 'wgServer', 'wgCanonicalServer' ] as $setting ) {
		// settings might be empty during PHPUnit tests
		foreach ( $wgConf->settings[$setting] ?? [] as $dbname => &$server ) {
			$server = preg_replace( '#^(http:)?//#', 'https://', $server );
			$httpPort = '<%= scope['forwarded_port'] %>';
			$httpsPort = '<%= scope['forwarded_https_port'] %>';
			$server = str_replace( ":$httpPort", ":$httpsPort", $server );
		}
	}
} );
